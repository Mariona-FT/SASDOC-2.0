{% extends 'base-template/base.html' %}

{% block title %}Gestió Caps Secció{% endblock %}

{% block content %}

<h2>Gestió dels Caps de Secció</h2>

<!-- Display success, warning, or error messages -->
{% if messages %}
    <div class="messages">
        {% for message in messages %}
            <div class="{% if message.tags %}alert alert-{{ message.tags }}{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    </div>
{% endif %}

<!-- Filter Fields -->
<div class="row mb-3">
    <div class="col-md-4">
            <label for="filter-name">Filtrar per Nom: </label>
            <input type="text" id="filter-name" class="form-control" placeholder="Cerca per Nom">
        </div>

        <div class="col-md-4">
            <label for="filter-family-name">Filtrar per Cognom: </label>
            <input type="text" id="filter-family-name" class="form-control" placeholder="Cerca per Cognom">
        </div>

        <div class="col-md-4">
            <label for="filter-active">Filtrar per si és Professorat actiu:</label>
            <select id="filter-active" class="form-control">
                <option value="">Tots</option>
                <option value="yes">Actiu</option>
                <option value="no">No Actiu</option>
            </select>
        </div>
    </div>
</div>
<br>

<!-- Create Professor Buttons -->
<div class="row mb-2">
    <div class="col text-center">
        <a href="{% url 'usersapp:register_professor' %}" class="button-secondary btn-sm">Registrar Professor Manualment</a>
        <a href="{% url 'usersapp:upload_professors' %}" class="button-secondary btn-sm">Registrar Professor per Fitxer</a>
    </div>
</div>

<!--Form to CREATE & UPDATE-->
    <h2>{% if form.instance.pk %}Actualitzar Professor{% else %}Crear Professor{% endif %}</h2>

    <!-- Form for creating/updating professors -->
    <form method="post" action="{% url 'usersapp:professor_crud' %}" class="mb-4">
        {% csrf_token %}
        <!-- Hidden input for idProfessor to UPDATE-->
        {% if form.instance.pk %}
            <input type="hidden" name="idProfessor" value="{{ form.instance.pk }}">
        {% endif %}
        
        <div class="mb-3">
            {{ form.as_p }} 
        </div>
        <button type="submit" class="button-create btn-sm">
            {% if form.instance.pk %}Actualitzar{% else %}Crear{% endif %} Professor
        </button>
    </form>

<hr>

<!-- List of all professors -->
<h3>Llista de Professors</h3>
<table class="table table-striped" id="professors-table">
    <thead>
        <tr>
            <th>Nom</th>
            <th>Cognoms</th>
            <th>Correu electrònic</th>
            <th>Està Actiu</th>
            <th>Accions</th>
        </tr>
    </thead>
    <tbody>
        {% if professors %}
            {% for professor in professors %}
                <tr>
                    <td>{{ professor.name }}</td>
                    <td>{{ professor.family_name }}</td>
                    <td>{{ professor.email }}</td>
                    <td class="active-status">{% if professor.isActive == 'yes' %}
                        Sí
                    {% else %}
                        No
                    {% endif %}</td>
                    <td>
                        <!-- Edit button -->
                        <a id="update-professor-btn" href="?edit={{ professor.pk }}" class="button-edit btn-sm">Editar</a>

                        <!-- Delete form with JavaScript confirmation -->
                        <form method="post" action="{% url 'usersapp:professor_crud' %}" style="display:inline;" onsubmit="return confirmDelete('{{ professor.name }} {{ professor.family_name }}');">
                            {% csrf_token %}
                            <input type="hidden" name="confirm_delete" value="{{ professor.pk }}">
                            <button type="submit" class="button-delete btn-sm">Eliminar</button>
                        </form>
                    </td>
                </tr>
            {% endfor %}
        {% else %}
            <tr>
                <td colspan="5" class="text-center">Cap professor en la taula.</td>
            </tr>        
        {% endif %}
    </tbody>
</table>

<!-- No results message -->
<div id="no-results-message" class="text-center text-danger" style="display:none;">
    <span id="no-results-text"></span>
</div>
<!-- JavaScript function for confirmation -->
<script>
    const createProfessorBtn = document.getElementById('create-professor-btn');
    const professorFormContainer = document.getElementById('professor-form-container');
    const editProfessorBtns = document.querySelectorAll('.btn-warning'); // Select all buttons with class btn-warning

    {%comment%}
    // Toggle form visibility
    createProfessorBtn.addEventListener('click', function() {
        professorFormContainer.style.display = professorFormContainer.style.display === 'none' ? 'block' : 'none';
    });
    {%endcomment%}

    // Handle edit buttons to show form and load data
    editProfessorBtns.forEach(btn => {
        btn.addEventListener('click', function (event) {
            professorFormContainer.style.display = 'block';
        });
    });

    function confirmDelete(professorName) {
        return confirm("Estàs segur que vols eliminar aquest professor: " + professorName + "?");
    }

   // JavaScript for Filtering
   document.addEventListener('DOMContentLoaded', function () {
    const filterName = document.getElementById('filter-name');
    const filterFamilyName = document.getElementById('filter-family-name');
    const filterActive = document.getElementById('filter-active');
    const tableRows = document.querySelectorAll('#professors-table tbody tr');
    const noResultsMessage = document.getElementById('no-results-message');
    const noResultsText = document.getElementById('no-results-text');

    function filterTable() {
        const nameValue = filterName.value.toLowerCase();
        const familyNameValue = filterFamilyName.value.toLowerCase();
        const activeValue = filterActive.value;       
        let rowsVisible = 0; // Track how many rows are visible
        let message = "Cap professor";

        // Filtering logic
        tableRows.forEach(row => {
            const nameText = row.cells[0].textContent.toLowerCase();
            const familyNameText = row.cells[1].textContent.toLowerCase();
            const isActiveText = row.querySelector('.active-status').textContent.trim(); // Get Si/No using the Class
            const isActive = isActiveText === 'Sí' ? 'yes' : 'no';

            const matchesName = nameText.includes(nameValue);
            const matchesFamilyName = familyNameText.includes(familyNameValue);
            const matchesActive = (activeValue === '' || isActive === activeValue);

            if (matchesName && matchesFamilyName && matchesActive) {
                row.style.display = '';
                rowsVisible++;
            } else {
                row.style.display = 'none';
            }
        });

        // Custom message logic for different filters
        if (rowsVisible === 0) {
            if (nameValue) {
                message += ` amb el nom "${nameValue}"`;
            }
            if (familyNameValue) {
                if (nameValue) {
                    message += `,`;
                }
                message += ` amb el cognom "${familyNameValue}"`;
            }
            if (activeValue) {
                if (nameValue || familyNameValue) {
                    message += `, i`;
                }
                message += ` actiu "${activeValue === 'yes' ? 'Sí' : 'No'}"`;
            }
            message += ".";
            noResultsText.textContent = message;
            noResultsMessage.style.display = 'block';
        } else {
            noResultsMessage.style.display = 'none';
        }
    }

    filterName.addEventListener('input', filterTable);
    filterFamilyName.addEventListener('input', filterTable);
    filterActive.addEventListener('change', filterTable);
});
</script>

{% endblock %}
